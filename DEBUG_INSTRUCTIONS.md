# Инструкции по отладке проблемы с totals-by-type

## Что я сделал

1. **Добавил подробное логирование** в endpoint `/api/credits/totals-by-type`
2. **Добавил тестовый endpoint** `/api/credits/totals-by-type-test` для проверки что сервер работает

## Шаги для отладки

### Шаг 1: Перезапустить сервер

**ОБЯЗАТЕЛЬНО!** Без этого изменения не применятся.

```bash
# В терминале где запущен сервер:
# 1. Нажмите Ctrl+C чтобы остановить
# 2. Запустите заново:
npm run server
```

### Шаг 2: Проверить тестовый endpoint

```bash
node -e "const http=require('http');http.get('http://localhost:3001/api/credits/totals-by-type-test',(r)=>{let d='';r.on('data',c=>d+=c);r.on('end',()=>console.log(d));})"
```

**Ожидаемый результат:**
```json
{"test":"working","investment":0,"working_capital":0,"total":0}
```

Если это работает, значит сервер запущен и маршрутизация работает.

### Шаг 3: Проверить основной endpoint

```bash
node test-endpoint.cjs
```

**Смотрите на логи в терминале сервера!**

Вы должны увидеть:
```
=== GET /api/credits/totals-by-type called ===
Executing query...
Query result: [...]
Processing row: ...
Sending response: ...
```

Или если ошибка:
```
=== ERROR in /api/credits/totals-by-type ===
Error type: ...
Error message: ...
```

### Шаг 4: Отправьте мне логи

Скопируйте ВСЕ логи из терминала сервера и отправьте мне.

## Возможные проблемы

### Проблема 1: Сервер не перезапустился

**Симптомы:**
- Тестовый endpoint не работает
- Нет логов в терминале

**Решение:**
- Убедитесь что старый процесс остановлен
- Проверьте что порт 3001 свободен:
  ```bash
  netstat -ano | Select-String ":3001"
  ```
- Если порт занят, убейте процесс и запустите заново

### Проблема 2: База данных недоступна

**Симптомы:**
- Логи показывают ошибку подключения к БД
- Error code: ECONNREFUSED или подобное

**Решение:**
- Проверьте что база данных доступна:
  ```bash
  node check-credits-db.cjs
  ```

### Проблема 3: Синтаксическая ошибка в коде

**Симптомы:**
- Сервер не запускается
- Ошибка при запуске

**Решение:**
- Проверьте логи запуска сервера
- Отправьте мне ошибку

## Быстрая проверка всего

Выполните эти команды по порядку и отправьте мне результаты:

```bash
# 1. Проверка базы данных
node check-credits-db.cjs

# 2. Проверка SQL запроса
node test-totals-query.cjs

# 3. Проверка тестового endpoint (после перезапуска сервера!)
curl http://localhost:3001/api/credits/totals-by-type-test

# 4. Проверка основного endpoint (после перезапуска сервера!)
node test-endpoint.cjs
```

## Что должно работать

После перезапуска сервера:

✅ База данных доступна (check-credits-db.cjs работает)  
✅ SQL запрос работает (test-totals-query.cjs работает)  
✅ Тестовый endpoint работает (totals-by-type-test возвращает JSON)  
❓ Основной endpoint - нужно проверить логи

## Следующие шаги

1. Перезапустите сервер
2. Выполните быструю проверку
3. Отправьте мне:
   - Логи из терминала сервера
   - Результаты всех 4 команд
   - Скриншот ошибки в браузере (если есть)

Тогда я смогу точно определить проблему!

---

**Жду результатов после перезапуска сервера.**
