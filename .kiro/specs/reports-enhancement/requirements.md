# Requirements Document

## Introduction

Данная спецификация описывает доработку двух существующих отчетов в системе финансового управления: "Прогноз платежей" и "Портфельный анализ". Основная цель - улучшить функциональность фильтрации, изменить формат отображения данных и добавить детализацию по кредитам в портфельном анализе с корректным расчетом средневзвешенной процентной ставки.

## Requirements

### Requirement 1: Активация фильтров в отчете "Прогноз платежей"

**User Story:** Как финансовый менеджер, я хочу фильтровать прогноз платежей по датам и банкам, чтобы видеть только релевантные данные для анализа.

#### Acceptance Criteria

1. WHEN пользователь выбирает "Дата от" в фильтре отчета "Прогноз платежей" THEN система SHALL применить фильтрацию к выборке кредитов, включая только те, у которых дата начала >= выбранной даты
2. WHEN пользователь выбирает "Дата до" в фильтре отчета "Прогноз платежей" THEN система SHALL применить фильтрацию к выборке кредитов, включая только те, у которых дата начала <= выбранной даты
3. WHEN пользователь выбирает конкретный банк в фильтре THEN система SHALL отображать прогноз платежей только для кредитов выбранного банка
4. WHEN пользователь выбирает "Все банки" в фильтре THEN система SHALL отображать прогноз платежей для всех банков
5. WHEN фильтры применены THEN система SHALL передавать параметры dateFrom, dateTo и bankId в API-запрос /api/reports/forecast

### Requirement 2: Замена формата экспорта на форму отчета

**User Story:** Как пользователь системы, я хочу выбирать между форматами отображения "Список" и "Таблица", чтобы просматривать данные прогноза в удобном для меня виде.

#### Acceptance Criteria

1. WHEN пользователь открывает отчет "Прогноз платежей" THEN система SHALL отображать выпадающий список "Форма отчета" вместо "Формат экспорта"
2. WHEN пользователь выбирает форму отчета THEN система SHALL предоставить опции "Список" и "Таблица"
3. WHEN выбрана форма "Список" THEN система SHALL отображать данные в формате: Банк | Кредит | Месяц | Остаток долга | Проценты | Всего
4. WHEN выбрана форма "Таблица" THEN система SHALL отображать данные в сводной таблице, сгруппированной по годам и месяцам
5. WHEN отображается форма "Таблица" THEN система SHALL показывать для каждого месяца суммы по каждому банку (остаток долга + проценты)
6. WHEN отображается форма "Таблица" THEN система SHALL включать итоговую строку с суммами по каждому банку и общим итогом

### Requirement 3: Отображение списка кредитов по банкам в портфельном анализе

**User Story:** Как финансовый аналитик, я хочу видеть детальный список кредитов для каждого банка в портфельном анализе, чтобы анализировать структуру портфеля на детальном уровне.

#### Acceptance Criteria

1. WHEN пользователь просматривает отчет "Портфельный анализ" THEN система SHALL отображать кнопку "Показать кредиты" рядом с названием каждого банка
2. WHEN пользователь нажимает "Показать кредиты" THEN система SHALL раскрывать подтаблицу с детальной информацией о кредитах данного банка
3. WHEN отображается список кредитов THEN система SHALL показывать следующие поля: Номер договора, Основная сумма, Остаток, Ставка, Выплачено, Дата начала
4. WHEN пользователь нажимает "Скрыть кредиты" THEN система SHALL скрывать подтаблицу с детальной информацией
5. WHEN отображается список кредитов THEN система SHALL форматировать денежные суммы согласно локальным настройкам (MDL)
6. WHEN список кредитов раскрыт THEN система SHALL сортировать кредиты по номеру договора

### Requirement 4: Расчет остатка кредита на указанную дату

**User Story:** Как финансовый менеджер, я хочу видеть остаток кредита на конкретную дату, чтобы анализировать состояние портфеля на определенный момент времени.

#### Acceptance Criteria

1. WHEN пользователь указывает дату в фильтре "Дата до" THEN система SHALL рассчитывать остаток кредита на указанную дату
2. WHEN пользователь не указывает дату в фильтре "Дата до" THEN система SHALL рассчитывать остаток кредита на текущую дату
3. WHEN рассчитывается остаток кредита THEN система SHALL вычитать из основной суммы все платежи, совершенные до указанной даты включительно
4. WHEN отображается остаток кредита THEN система SHALL использовать формулу: остаток = основная сумма - сумма всех платежей
5. WHEN рассчитывается остаток для списка кредитов THEN система SHALL применять одну и ту же дату для всех кредитов в отчете

### Requirement 5: Расчет средневзвешенной процентной ставки

**User Story:** Как финансовый аналитик, я хочу видеть корректную средневзвешенную процентную ставку по портфелю банка, чтобы точно оценивать стоимость заимствований.

#### Acceptance Criteria

1. WHEN система рассчитывает среднюю ставку для банка THEN система SHALL использовать метод взвешенного среднего по остаткам кредитов
2. WHEN рассчитывается взвешенная ставка THEN система SHALL использовать формулу: средняя ставка = сумма(остаток × ставка) / сумма(остатков)
3. WHEN определяется текущая ставка кредита THEN система SHALL использовать ставку, актуальную на дату из фильтра "Дата до" или на текущую дату
4. WHEN выбирается актуальная ставка THEN система SHALL запрашивать из таблицы credit_rates запись с максимальной effective_date, не превышающей указанную дату
5. IF для кредита не найдена актуальная ставка THEN система SHALL использовать значение 0% для расчетов
6. WHEN отображается средняя ставка THEN система SHALL форматировать значение с точностью до 2 знаков после запятой
7. WHEN рассчитывается общая средняя ставка по всем банкам THEN система SHALL использовать тот же метод взвешенного среднего

### Requirement 6: Обновление серверного API для прогноза платежей

**User Story:** Как разработчик, я хочу, чтобы API-эндпоинт /api/reports/forecast поддерживал фильтрацию, чтобы клиентская часть могла получать отфильтрованные данные.

#### Acceptance Criteria

1. WHEN API получает запрос на /api/reports/forecast THEN система SHALL принимать параметры dateFrom, dateTo и bankId из query string
2. WHEN параметр dateFrom передан THEN система SHALL добавлять условие WHERE для фильтрации кредитов по дате начала >= dateFrom
3. WHEN параметр dateTo передан THEN система SHALL добавлять условие WHERE для фильтрации кредитов по дате начала <= dateTo
4. WHEN параметр bankId передан и не равен 'all' THEN система SHALL добавлять условие WHERE для фильтрации кредитов по bank_id = bankId
5. WHEN фильтры применены THEN система SHALL генерировать прогноз платежей только для отфильтрованных кредитов
6. WHEN запрос выполнен успешно THEN система SHALL возвращать JSON с данными прогноза
7. IF возникает ошибка при выполнении запроса THEN система SHALL возвращать статус 500 и сообщение об ошибке

### Requirement 7: Обновление серверного API для портфельного анализа

**User Story:** Как разработчик, я хочу, чтобы API-эндпоинт /api/reports/portfolio возвращал детальную информацию о кредитах и корректно рассчитывал средневзвешенные ставки.

#### Acceptance Criteria

1. WHEN API получает запрос на /api/reports/portfolio THEN система SHALL возвращать данные, сгруппированные по банкам
2. WHEN формируется ответ для банка THEN система SHALL включать массив credits с детальной информацией о каждом кредите
3. WHEN рассчитывается avgRate для банка THEN система SHALL использовать метод взвешенного среднего по остаткам
4. WHEN запрашиваются данные кредита THEN система SHALL выполнять JOIN с таблицами banks и payments
5. WHEN рассчитывается текущая ставка кредита THEN система SHALL выполнять дополнительный запрос к таблице credit_rates
6. WHEN формируется объект кредита THEN система SHALL включать поля: id, contractNumber, principal, startDate, paidAmount, remainingBalance, rate
7. WHEN рассчитываются итоговые показатели THEN система SHALL суммировать totalPrincipal, totalCredits и totalPaid по всем банкам
8. IF возникает ошибка при выполнении запроса THEN система SHALL возвращать статус 500 и сообщение об ошибке
