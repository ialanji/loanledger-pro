# Исправление расчета процентов на дашборде

## Проблема

На дашборде в разделе "Общая информация по кредитам" показывалась неправильная цифра для **ПРОЦЕНТЫ**: `472.430 L`

Эта цифра должна показывать **остаточные проценты до конца периода всех кредитов**, то есть сумму всех будущих процентных платежей, которые еще нужно выплатить.

## Причина проблемы

Старый код пытался получить данные графика платежей только для **первого кредита** из списка:

```typescript
// Старый код - НЕПРАВИЛЬНО
let scheduleData = null;
if (credits.length > 0) {
  const scheduleResponse = await fetch(`/api/credits/${credits[0].id}/schedule`);
  // ...
}
```

Это приводило к тому, что:
1. Учитывались проценты только одного кредита
2. Если у первого кредита не было графика, использовался неточный fallback-расчет
3. Цифра не отражала реальную картину по всем кредитам

## Решение

Теперь код:
1. **Получает графики платежей для ВСЕХ активных кредитов**
2. **Суммирует общую сумму процентов из всех графиков**
3. **Вычитает уже выплаченные проценты**

### Изменения в коде

#### 1. Получение графиков для всех кредитов

```typescript
// Новый код - ПРАВИЛЬНО
const allScheduleData = [];
const activeCredits = credits.filter(c => c.status === 'active');

for (const credit of activeCredits) {
  try {
    const scheduleResponse = await fetch(`/api/credits/${credit.id}/schedule`);
    if (scheduleResponse.ok) {
      const scheduleData = await scheduleResponse.json();
      allScheduleData.push({
        creditId: credit.id,
        schedule: scheduleData
      });
    }
  } catch (scheduleError) {
    console.warn(`Could not fetch schedule data for credit ${credit.id}:`, scheduleError);
  }
}
```

#### 2. Расчет остаточных процентов

```typescript
// Суммируем общую сумму процентов из всех графиков
const totalInterestFromAllSchedules = allScheduleData.reduce((sum, scheduleItem) => {
  const totalInterest = parseNumeric(scheduleItem.schedule?.totals?.totalInterest || 0);
  return sum + totalInterest;
}, 0);

// Вычисляем выплаченные проценты
const paidInterest = payments
  .filter(p => p.status === 'paid')
  .reduce((sum, payment) => {
    const interestPaid = parseNumeric(payment.interestDue || payment.interest_due);
    return sum + interestPaid;
  }, 0);

// Остаточные проценты = Общая сумма - Выплачено
remainingInterest = Math.max(0, totalInterestFromAllSchedules - paidInterest);
```

## Формула расчета

```
Остаточные проценты = Σ(Общая сумма процентов по каждому кредиту) - Σ(Выплаченные проценты)
```

Где:
- **Общая сумма процентов по кредиту** берется из `schedule.totals.totalInterest` для каждого активного кредита
- **Выплаченные проценты** - это сумма всех `interest_due` из платежей со статусом `paid`

## Что показывает цифра "ПРОЦЕНТЫ"

Теперь эта цифра корректно показывает:
- **Сумму всех будущих процентных платежей** по всем активным кредитам
- **До конца срока действия кредитов**
- **С учетом уже выплаченных процентов**

## Пример расчета

Допустим у вас 3 кредита:

| Кредит | Общая сумма процентов | Выплачено процентов | Остаток процентов |
|--------|----------------------|---------------------|-------------------|
| Кредит 1 | 500,000 L | 100,000 L | 400,000 L |
| Кредит 2 | 300,000 L | 50,000 L | 250,000 L |
| Кредит 3 | 200,000 L | 0 L | 200,000 L |
| **ИТОГО** | **1,000,000 L** | **150,000 L** | **850,000 L** |

На дашборде будет показано: **ПРОЦЕНТЫ: 850,000 L**

## Fallback-логика

Если по какой-то причине не удается получить графики платежей, используется fallback-расчет:
- Суммируются все процентные платежи из таблицы `payments`
- Вычитаются выплаченные проценты
- Результат может быть менее точным, но все равно даст приблизительную оценку

## Логирование

Для отладки добавлено подробное логирование:
```typescript
console.log('Interest calculation from schedules:', {
  totalInterestFromAllSchedules,
  paidInterest,
  remainingInterest
});
```

Вы можете открыть консоль браузера (F12) и увидеть детальный расчет.

## Файлы изменены

- `src/pages/Dashboard.tsx` - Обновлена логика получения и расчета процентов

## Тестирование

Для проверки правильности расчета:
1. Откройте дашборд
2. Откройте консоль браузера (F12)
3. Найдите логи "Interest calculation from schedules"
4. Проверьте:
   - `totalInterestFromAllSchedules` - должна быть сумма всех процентов по всем кредитам
   - `paidInterest` - должна быть сумма выплаченных процентов
   - `remainingInterest` - должна быть разница между ними

## Результат

Теперь цифра "ПРОЦЕНТЫ" на дашборде корректно показывает остаточную сумму процентов, которую нужно выплатить по всем активным кредитам до конца их срока действия.
